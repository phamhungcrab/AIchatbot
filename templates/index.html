{% extends "base.html" %}

{% block title %}New Chat{% endblock %}

{% block content %}
<!-- Sidebar -->
<aside class="sidebar">
    <button class="new-chat-btn" onclick="window.location.href='/'">
        <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round"
            stroke-linejoin="round" height="16" width="16" xmlns="http://www.w3.org/2000/svg">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        New chat
    </button>

    <div class="sidebar-nav">
        <!-- Future: Chat history list could go here -->
    </div>

    <div class="sidebar-footer">
        <form action="/clear" method="POST">
            <button type="submit" class="clear-btn">
                <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round"
                    stroke-linejoin="round" height="16" width="16" xmlns="http://www.w3.org/2000/svg">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
                Clear conversations
            </button>
        </form>
    </div>
</aside>

<!-- Main Chat Area -->
<main class="main-content">
    <div class="chat-box" id="chat-box">
        {% if chat_history %}
        {% for msg in chat_history %}
        <!-- User Message -->
        <div class="message user">
            <div class="message-content">
                <div class="avatar user-avatar">
                    <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round"
                        stroke-linejoin="round" height="20" width="20" xmlns="http://www.w3.org/2000/svg" color="white">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="text">{{ msg.user }}</div>
            </div>
        </div>

        <!-- Bot Message -->
        <div class="message bot">
            <div class="message-content">
                <div class="avatar bot-avatar">
                    <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round"
                        stroke-linejoin="round" height="20" width="20" xmlns="http://www.w3.org/2000/svg" color="white">
                        <path d="M12 2a10 10 0 1 0 10 10H12V2z"></path>
                        <path d="M12 2a10 10 0 0 1 10 10h-10V2z"></path>
                        <path d="M12 12L2.5 7.5"></path>
                        <path d="M12 12l9.5-4.5"></path>
                    </svg>
                </div>
                <div class="text">
                    {{ msg.bot }}

                    <!-- Confidence Info -->
                    {% if msg.confidence is defined and msg.confidence > 0 %}
                    <div class="confidence-info">
                        <div class="confidence-bar-container">
                            <div class="confidence-bar" style="width: {{ (msg.confidence * 100)|round }}%"></div>
                        </div>

                        {% if msg.confidence >= 0.85 %}
                        <span class="confidence-badge high">High Confidence</span>
                        {% elif msg.confidence >= 0.70 %}
                        <span class="confidence-badge medium">Medium Confidence</span>
                        {% elif msg.confidence >= 0.55 %}
                        <span class="confidence-badge low">Low Confidence</span>
                        {% else %}
                        <span class="confidence-badge very-low">Very Low Confidence</span>
                        {% endif %}

                        <details class="confidence-details">
                            <summary>Details</summary>
                            <ul>
                                <li>Topic: <strong>{{ msg.topic }}</strong> ({{ (msg.topic_conf * 100)|round }}%)</li>
                                <li>Sim: {{ (msg.question_sim * 100)|round }}%</li>
                            </ul>
                        </details>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="message bot">
            <div class="message-content">
                <div class="avatar bot-avatar">
                    <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round"
                        stroke-linejoin="round" height="20" width="20" xmlns="http://www.w3.org/2000/svg" color="white">
                        <path d="M12 2a10 10 0 1 0 10 10H12V2z"></path>
                        <path d="M12 2a10 10 0 0 1 10 10h-10V2z"></path>
                        <path d="M12 12L2.5 7.5"></path>
                        <path d="M12 12l9.5-4.5"></path>
                    </svg>
                </div>
                <div class="text">Hello! I am your AI assistant. How can I help you today?</div>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="input-area">
        <form action="/" method="POST" class="input-form">
            <div class="input-container">
                <textarea id="user-input" name="user_message" placeholder="Send a message..." required autofocus
                    rows="1"></textarea>
                <button type="submit" class="send-btn">
                    <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round"
                        stroke-linejoin="round" height="16" width="16" xmlns="http://www.w3.org/2000/svg">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </form>
    </div>
</main>
{% endblock %}